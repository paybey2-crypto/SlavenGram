<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
</head>
<body>

<h1 id="welcome">Loading...</h1>

<hr>

<h2>Your balance:</h2>
<p id="balance">Loading...</p>

<hr>

<h2>Send money to user</h2>
<form id="transferForm">
  <input type="text" name="toUsername" placeholder="Username">
  <input type="number" name="amount" placeholder="Amount">
  <button type="submit">Send</button>
</form>

<hr>

<h2>Send to IBAN</h2>
<form id="ibanForm">
  <input type="text" name="iban" placeholder="IBAN">
  <input type="number" name="amount" placeholder="Amount">
  <button type="submit">Send</button>
</form>

<hr>

<h2>Your Virtual Cards</h2>
<div id="cards"></div>
<button id="newCardBtn">Create new card</button>

<hr>

<div id="adminPanel"></div>

<form method="POST" action="/logout">
<button>Logout</button>
</form>

<script>
async function loadUser() {
  const r = await fetch('/api/me', { credentials: "same-origin" });
  const user = await r.json();
  document.getElementById('welcome').innerHTML = "Welcome, " + user.username;

  return user.username;
}

async function loadBalance(username) {
  const res = await fetch('/api/users', { credentials: 'same-origin' });
  if (res.status === 200) {
    const users = await res.json();
    const u = users.find(x => x.username === username);
    document.getElementById('balance').innerHTML = "$" + u.balance;
  }
}

async function loadCards() {
  const r = await fetch('/api/cards', { credentials: 'same-origin' });
  const cards = await r.json();

  const container = document.getElementById('cards');
  container.innerHTML = "";

  cards.forEach(c => {
    container.innerHTML += `
      <p>Card: ${c.number}<br>
      Expiry: ${c.expiry}<br>
      CVV: ${c.cvv}</p><hr>`;
  });
}

document.getElementById('newCardBtn').onclick = async () => {
  const r = await fetch('/api/createCard', {
    method: "POST",
    credentials: "same-origin"
  });

  if (r.status !== 200) {
    alert(await r.text());
    return;
  }

  alert("New card created!");
  loadCards();
};

document.getElementById('transferForm').onsubmit = async e => {
  e.preventDefault();
  const toUsername = e.target.toUsername.value;
  const amount = +e.target.amount.value;

  const r = await fetch('/api/transfer', {
    method: "POST",
    credentials: "same-origin",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ toUsername, amount })
  });

  if (r.status !== 200) return alert(await r.text());
  alert("Transfer successful");
  loadDashboard();
};

document.getElementById('ibanForm').onsubmit = async e => {
  e.preventDefault();

  const iban = e.target.iban.value;
  const amount = +e.target.amount.value;

  const r = await fetch('/api/iban', {
    method: "POST",
    credentials: "same-origin",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ iban, amount })
  });

  if (r.status !== 200) return alert(await r.text());
  alert("IBAN transfer successful");
  loadDashboard();
};

async function loadAdminPanel(username) {
  if (username !== "admin") return;

  const r = await fetch('/api/users', { credentials: "same-origin" });
  const users = await r.json();

  const div = document.getElementById('adminPanel');
  div.innerHTML = "<h2>All users</h2>";

  users.forEach(u => {
    div.innerHTML += <p>${u.username} — $${u.balance} — Cards: ${u.cardCount}</p>;
  });
}

async function loadDashboard() {
  const username = await loadUser();
  await loadBalance(username);
  await loadCards();
  await loadAdminPanel(username);
}

loadDashboard();
</script>
</body>
</html>
